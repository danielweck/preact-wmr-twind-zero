name: CI
on:
  push:
    branches: [ main ]
    paths-ignore:
      - '.husky'
    tags-ignore:
      - '*'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '.husky'
env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
jobs:
  build:
    timeout-minutes: 10
    if: "github.event_name == 'pull_request' || !contains(github.event.head_commit.message, 'skip ci')"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        node: ['16.x']
        os: [ubuntu-latest]
        include:
          - os: ubuntu-latest
            osname: linux
    name: Node v${{ matrix.node }} on ${{ matrix.os }} (${{ matrix.osname }})
    env:
      GIHUB_ACTIONS_OS_NAME: ${{ matrix.osname }}
    steps:
    - run: echo 'GIHUB_ACTIONS_OS_NAME:' ${{ env.GIHUB_ACTIONS_OS_NAME }}
    - run: 'echo "GITHUB_RUN_NUMBER: ${{ github.run_number }}"'
    - run: 'echo "GITHUB_RUN_ID: ${{ github.run_id }}"'
    - run: 'echo "GITHUB_SHA: ${{ github.sha }}"'
    - name: Checkout
      uses: actions/checkout@v2
      with:
        ref: main
    - name: Git config global dump (post)
      run: 'git config --global --list || echo NO_GIT_GLOBAL_CONFIG || true'
      shell: bash
    - name: Git config local dump (post)
      run: 'git config --list || echo NO_GIT_GLOBAL_CONFIG || true'
      shell: bash
    - name: Node v${{ matrix.node }}
      uses: actions/setup-node@v2
      with:
        node-version: ${{ matrix.node }}
    #    cache: pnpm
    #    cache-dependency-path: '**/pnpm-lock.yaml'
    #- run: npm --global install npm@^8
    - name: PNPM cache
      uses: actions/cache@v2
      with:
        path: ~/.pnpm-store
        key: ${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-
    # - run: npm --global install pnpm
    # - run: pnpm install --frozen-lockfile
    - name: PNPM install
      uses: pnpm/action-setup@v2.0.1
      with:
        version: 6.29.1
        run_install: |
          - recursive: false
            args: [--frozen-lockfile]
    #    - args: [--global, typescript]
    - name: ENV
      run: |
        echo cwd: `pwd`;
        echo branch `git branch --show-current`;
        echo node `node --version`;
        echo npm `npm --version`;
        echo pnpm `pnpm --version`
    - run: git --no-pager diff
    - name: PR action (just lint)
      if: ${{ github.event_name == 'pull_request' }}
      run: pnpm lint
    - name: non-PR action (lint and build)
      if: ${{ github.event_name != 'pull_request' }}
      run: pnpm lint && pnpm build-github-repeat-if-fail && ls -R dist && mv dist/preact-wmr-twind-zero/* dist/ && rm -r dist/preact-wmr-twind-zero && rm dist/*.ts && rm dist/chunks/prerender*
    - name: Checkout GH-PAGES
      if: ${{ github.event_name != 'pull_request' }}
      uses: actions/checkout@v2
      with:
        ref: gh-pages
        path: gh-pages
    - name: Copy dist to GH-PAGES
      run: |
          cp gh-pages/.gitignore dist/
          rm -rf gh-pages/*
          cd gh-pages
          ls -als
          cp -r ../dist/* ./
          touch .nojekyll
          ls -als
          git config user.name "Daniel Weck"
          git config user.email daniel.weck@gmail.com
          git add .
          git commit -m "chore(dist): automated GitHub Actions CI dist update" || echo "ok"
          git push
